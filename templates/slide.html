<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Slide {{ slide_id + 1 }} of {{ total }}</title>
  <style>
    .progress-bar {
      width: 100%;
      height: 12px;
      background-color: #e0e0e0;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-fill {
      height: 100%;
      background-color: #4caf50;
      transition: width 0.3s ease-in-out;
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body style="font-family: sans-serif; padding: 20px;">

<!-- üìà Progress Tracker + Dropdown -->
<div style="display: flex; justify-content: space-between; align-items: center;">
  <h2>Slide {{ slide_id + 1 }} of {{ total }} ({{ ((slide_id + 1) / total * 100) | round(0) }}%)</h2>
  <form onchange="goToSlide(this)">
    <select name="slideSelect" style="padding: 5px;">
      {% for i in range(total) %}
        <option value="{{ i }}" {% if i == slide_id %}selected{% endif %}>Go to Slide {{ i + 1 }}</option>
      {% endfor %}
    </select>
  </form>
</div>

<div class="progress-bar">
  <div class="progress-fill" style="width: {{ ((slide_id + 1) / total * 100) }}%;"></div>
</div>

{% if image %}
  <img src="{{ image }}" style="max-width:100%; border-radius:8px; margin-bottom:20px;">
{% endif %}

<h3>AI Explanation:</h3>
<div style="background:#f5f5f5; padding:10px; border-radius:8px;">
  {{ explanation|safe }}
  <br>
  <button onclick="speak(document.getElementById('explanationText').innerText)">üîä Speak Explanation</button>
  <div id="explanationText" style="display:none;">{{ explanation|striptags }}</div>
</div>

<h4>Ask a Question:</h4>
<form id="askForm" method="post" action="/ask">
  <input type="hidden" name="slide_index" value="{{ slide_id }}">
  <input type="text" id="questionInput" name="question" placeholder="Ask a question about this slide" required style="width: 70%;">
  <input type="submit" id="askBtn" value="Ask">

  <!-- Loader appears after clicking Ask -->
  <span id="askLoading" style="display:none; margin-left:10px; color: #1d4ed8; font-weight: bold;">
    <svg style="width:16px;height:16px;vertical-align:middle;" class="animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
    </svg>
    Thinking...
  </span>
</form>

{% if answer %}
  <div style="background:#e6ffe6; padding:10px; border-radius:8px; margin-top:10px;">
    <strong>Your Question:</strong> {{ question }}<br>
    <strong>AI Answer:</strong> {{ answer|safe }}
    <br>
    <button onclick="speak(document.getElementById('answerText').innerText)">üîä Speak Answer</button>
    <div id="answerText" style="display:none;">{{ answer|striptags }}</div>
  </div>
{% endif %}

<h4>üß† Flashcards:</h4>
<div style="background:#eef6ff; padding:10px; border-radius:8px;">
  {{ flashcard|safe }}
  <br>
  <button onclick="speak(document.getElementById('flashcardText').innerText)">üîä Speak Flashcards</button>
  <button onclick="downloadFlashcards()">üíæ Download Flashcards</button>
  <div id="flashcardText" style="display:none;">{{ flashcard|striptags }}</div>
</div>

<!-- üîá Stop Button -->
<div style="margin-top: 15px;">
  <button onclick="stopSpeaking()">‚ùå Stop Speaking</button>
</div>

<!-- Navigation -->
<div style="margin-top:20px;">
  {% if slide_id > 0 %}
    <a href="/slide/{{ slide_id - 1 }}">‚Üê Previous</a>
  {% endif %}
  {% if slide_id + 1 < total %}
    <a href="/slide/{{ slide_id + 1 }}" style="float:right;">Next ‚Üí</a>
  {% endif %}
</div>

<!-- JavaScript -->
<script>
function speak(text) {
  stopSpeaking();
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = 'en-US';
  window.speechSynthesis.speak(msg);
}

function stopSpeaking() {
  window.speechSynthesis.cancel();
}

function downloadFlashcards() {
  const text = document.getElementById('flashcardText').innerText;
  const blob = new Blob([text], { type: 'text/plain' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `flashcards_slide_{{ slide_id + 1 }}.txt`;
  link.click();
}

function goToSlide(form) {
  const index = form.slideSelect.value;
  window.location.href = "/slide/" + index;
}

// Loader for Ask Question button
document.getElementById('askForm').addEventListener('submit', function () {
  document.getElementById('askBtn').disabled = true;
  document.getElementById('askBtn').style.opacity = "0.5";
  document.getElementById('askLoading').style.display = 'inline-flex';
});
</script>

</body>
</html>
